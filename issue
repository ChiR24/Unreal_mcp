# Detailed Debugging Report: World Tools Test Suite
**Date:** January 30, 2026
**Subject:** `world-tools.test.mjs` vs. Unreal Engine Internal Logs
**Pass Rate Overview:**
*   **Total Tests:** 316
*   **Reported Passed:** 239 (75.6%)
*   **Reported Failed:** 77
*   **Actual Functional Pass Rate:** Estimated < 50% (due to dispatch bugs and false positives)

This report correlates the **Node.js Test Runner** outputs with the **Unreal Engine Internal Logs** to identify the root causes of failures.

---

## 1. ðŸš¨ Critical Dispatch Logic Error (The "Session Handler" Bug)

**Severity:** Critical
**Affected Tests:** ~30 Tests (Ray Tracing, Path Tracing, Scene Capture, Light Channels, Lightmass)

A massive block of lighting and rendering tests are failing with a bizarre error message indicating they are being routed to the wrong C++ handler entirely.

*   **Test Command:** `Lighting: configure_ray_traced_shadows enable`
*   **TS Result:** `[FAILED] ... Error: Execution failed: Unknown manage_level_structure action: `
*   **Unreal Log Trace:**
    ```text
    LogMcpSessionsHandlers: HandleManageSessionsAction: SubAction=configure_ray_traced_shadows, RequestId=...
    LogMcpLevelStructureHandlers: HandleManageLevelStructureAction: SubAction=
    [ErrorHandler] Tool manage_lighting failed: {"type":"EXECUTION","message":"Unknown manage_level_structure action: ","code":"INTERNAL_ERROR"}
    ```
*   **Analysis:**
    The `manage_lighting` tool request is improperly being routed to `HandleManageSessionsAction` inside the C++ plugin. That handler then seemingly calls `HandleManageLevelStructureAction` with an **empty string** for the sub-action.
    *   **Root Cause:** In `McpAutomationBridgeSubsystem.cpp` (or the main dispatch file), the `Switch` statement or `Map` for tool routing likely has a copy-paste error where `configure_ray_traced_...` keys are mapped to the Session handler instead of the Lighting handler.

---

## 2. ðŸ”Œ Missing C++ Implementations ("Unknown lighting action")

**Severity:** High
**Affected Tests:** ~20 Tests (Post Process, Bloom, Exposure, Reflections)

The TypeScript client sends valid requests, but the C++ `HandleManageLightingAction` function does not have `case` statements for these specific strings.

*   **Test Command:** `Lighting: create_post_process_volume infinite`
    *   **Unreal Log:** `[ErrorHandler] Tool manage_lighting failed: {"type":"UNKNOWN","message":"Unknown lighting action: create_post_process_volume"}`
*   **Test Command:** `Lighting: configure_bloom success`
    *   **Unreal Log:** `{"type":"UNKNOWN","message":"Unknown lighting action: configure_bloom"}`
*   **Test Command:** `Lighting: create_sphere_reflection_capture success`
    *   **Unreal Log:** `{"type":"UNKNOWN","message":"Unknown lighting action: create_sphere_reflection_capture"}`

**Missing Actions List:**
`create_post_process_volume`, `configure_pp_blend`, `configure_pp_priority`, `get_post_process_settings`, `configure_bloom`, `configure_dof`, `configure_motion_blur`, `configure_color_grading`, `configure_white_balance`, `configure_vignette`, `configure_chromatic_aberration`, `configure_film_grain`, `configure_lens_flares`, `create_sphere_reflection_capture`, `create_box_reflection_capture`, `create_planar_reflection`, `recapture_scene`.

---

## 3. ðŸ§© Missing Prerequisite Assets (Tests failing due to missing files)

**Severity:** Medium
**Affected Tests:** Landscape Grass, Spline Meshes, Foliage

Tests failed because specific assets expected by the test script do not exist in the Unreal project content.

*   **Test Command:** `Environment: create_landscape_grass_type success`
    *   **Unreal Log:** `Automation request failed: Static mesh not found: /Game/WorldToolsTest (ASSET_NOT_FOUND)`
    *   **Fix:** Create a dummy Static Mesh at `/Game/WorldToolsTest`.

*   **Test Command:** `Volumes: create_spline_mesh_component success`
    *   **Unreal Log:**
        ```text
        LogStreaming: Warning: LoadPackage: SkipPackage: /Game/Blueprints/SplineMeshBP ... does not exist
        Automation request failed: Blueprint not found: /Game/Blueprints/SplineMeshBP
        ```
    *   **Fix:** Create a Blueprint Actor named `SplineMeshBP` in `/Game/Blueprints/`.

*   **Test Command:** `Environment: configure_foliage_density success`
    *   **Unreal Log:** `Automation request failed: Foliage type 'TestFoliage' not found (FOLIAGE_TYPE_NOT_FOUND)`
    *   **Fix:** Ensure the foliage type created in earlier tests is saved, or create `/Game/Foliage/TestFoliage` manually.

---

## 4. ðŸ‘» False Positives (Phantom Passes)

**Severity:** Medium
Tests that the runner marked **[PASSED]** but which actually failed to generate valid results in the engine.

*   **Test Command:** `Environment: create_landscape_grass_type with mesh`
    *   **TS Result:** `[PASSED]`
    *   **Unreal Log:**
        ```text
        LogStreaming: Warning: LoadPackage: SkipPackage: /Game/Landscape/GrassType_Custom ... The package to load does not exist on disk or in the loader
        LogUObjectGlobals: Warning: Failed to find object 'LandscapeGrassType None./Game/Landscape/GrassType_Custom'
        ```
    *   **Issue:** The C++ code claimed success ("Landscape grass type created"), but the engine failed to save/load the package immediately after creation.

*   **Test Command:** `Environment: bake_lightmap success`
    *   **TS Result:** `[PASSED]`
    *   **Unreal Log:** `LogStaticLightingSystem: Warning: WorldSettings.bForceNoPrecomputedLighting is true, Skipping Lighting Build!`
    *   **Issue:** The test "Passed" because the command was sent, but Unreal explicitly **skipped** the action because the map template has "Force No Precomputed Lighting" enabled.

---

## 5. ðŸ“‰ Logic & State Failures

**Severity:** Low (Specific Edge Cases)

*   **Test Command:** `Environment: modify_heightmap success`
    *   **Unreal Log:** `Automation request failed: Failed to get landscape extent. Landscape may not be fully initialized. (INVALID_LANDSCAPE)`
    *   **Analysis:** The landscape created in `create_landscape` exists, but its collision or data interface wasn't fully initialized by the time this test ran.
    *   **Fix:** In C++, call `ALandscape::RecreateCollisionComponents()` or force an update after creation.

*   **Test Command:** `Environment: delete landscape`
    *   **Unreal Log:** `Automation request failed: Some environment actors could not be removed (DELETE_PARTIAL)`
    *   **Analysis:** The Water Brush Manager or other attached actors prevented the landscape from being deleted cleanly.

---